---
# Tasks for testing role

- name: Run idempotence test
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `debian-9`)
           || starts_with(name, `fedora-27`)
           || starts_with(name, `fedora-28`) ]

    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: Test sudo role with defaults
  hosts: docker_sandbox_containers
  vars:
  roles:
    - amtega.sudo

- name: Create unmanaged sudoers.d file for later tests
  hosts: docker_sandbox_containers
  tasks:
    - name: Create /etc/sudoers.d/unmanaged
      copy:
        content: ""
        dest: /etc/sudoers.d/unmanaged
        force: no

- name: Test disabled deletion of unamanged sudoers.d
  hosts: docker_sandbox_containers
  roles:
    - role: amtega.sudo
      sudo_delete_unamanaged: false
  tasks:
    - name: Check /etc/sudoers.d/unmanaged file
      stat:
        path: /etc/sudoers.d/unmanaged
      register: check_sudoers_d_unamanaged_result

    - name: Check sudoers.d content
      assert:
        that: check_sudoers_d_unamanaged_result.stat.exists

- name: Prepare docker containers for test
  hosts: docker_sandbox_containers
  tasks:
    - name: Setup extra sudoers
      set_fact:
        sudo_sudoers_d_operators:
          operators: |
            User_Alias OPERATORS = %grp-org-pxg-amtega-ait-ds--linux-sudo-operators
  tags:
    - idempotence

- name: Test enabled deletion of unamanged sudoers.d and complex config
  hosts: docker_sandbox_containers
  vars:
    sudo_sudoers_d:
      defaults: |
        Defaults    requiretty
        Defaults    !visiblepw
        Defaults    always_set_home
        Defaults    env_reset
        Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin
      wheel: |
        %wheel	ALL=(ALL)	ALL
      administrators: |
        User_Alias ADMINISTRATORS = %grp-org-pxg-amtega-ait-ds--linux-sudo
        ADMINISTRATORS ALL=(ALL) ALL

    sudo_load_sudoers_d_from_hostvars: yes
  roles:
    - amtega.sudo
  tasks:
    - name: Check /etc/sudoers.d/unmanaged file
      stat:
        path: /etc/sudoers.d/unmanaged
      register: check_sudoers_d_unamanaged_result

    - name: Check /etc/sudoers.d/defaults file
      stat:
        path: /etc/sudoers.d/unmanaged
      register: check_sudoers_d_defaults_result

    - name: Check /etc/sudoers.d/defaults file
      stat:
        path: /etc/sudoers.d/defaults
      register: check_sudoers_d_defaults_result

    - name: Check /etc/sudoers.d/wheel file
      stat:
        path: /etc/sudoers.d/wheel
      register: check_sudoers_d_wheel_result

    - name: Check /etc/sudoers.d/administrators file
      stat:
        path: /etc/sudoers.d/administrators
      register: check_sudoers_d_administrators_result

    - name: Check /etc/sudoers.d/operators file
      stat:
        path: /etc/sudoers.d/operators
      register: check_sudoers_d_operators_result

    - name: Check sudoers.d content
      assert:
        that:
          - not check_sudoers_d_unamanaged_result.stat.exists
          - check_sudoers_d_defaults_result.stat.exists
          - check_sudoers_d_wheel_result.stat.exists
          - check_sudoers_d_administrators_result.stat.exists
          - check_sudoers_d_operators_result.stat.exists
  tags:
    - idempotence

- name: Cleanup docker docker sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
